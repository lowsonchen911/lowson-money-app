<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家庭記帳 PWA (自定義版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .app-container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col">
    
    <header class="bg-slate-800 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
        <h1 class="text-lg font-bold">家庭記帳 PWA</h1>
        <button @click="exportCSV" class="text-xs bg-green-600 px-2 py-1 rounded hover:bg-green-500">匯出 CSV</button>
    </header>

    <div v-if="currentTab !== 'settings'" class="p-4 bg-slate-800 text-white rounded-b-3xl shadow-lg mb-4 transition-all">
        <div class="text-slate-400 text-sm">目前總資產</div>
        <div class="text-4xl font-bold my-2">{{ formatMoney(totalAssets) }}</div>
        <div class="flex gap-2 mt-4 overflow-x-auto pb-2 no-scrollbar">
            <div v-for="(balance, acc) in accountBalances" :key="acc" class="bg-slate-700 px-3 py-2 rounded-lg min-w-[120px] flex-shrink-0">
                <div class="text-xs text-slate-300 truncate">{{ acc }}</div>
                <div class="font-semibold" :class="balance < 0 ? 'text-red-400' : 'text-green-400'">{{ formatMoney(balance) }}</div>
            </div>
        </div>
    </div>

    <div class="flex justify-center gap-2 mb-4 px-4">
        <button @click="currentTab = 'list'" :class="currentTab === 'list' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">列表</button>
        <button @click="currentTab = 'add'" :class="currentTab === 'add' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">記一筆</button>
        <button @click="currentTab = 'chart'" :class="currentTab === 'chart' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">報表</button>
        <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">設定</button>
    </div>

    <div v-if="currentTab === 'list'" class="flex-1 overflow-y-auto px-4 pb-20">
        <div v-if="transactions.length === 0" class="text-center text-gray-400 mt-10">
            目前沒有資料，快去記一筆吧！
        </div>
        <div v-for="(tx, index) in sortedTransactions" :key="index" class="bg-white border-b border-gray-100 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                     :class="getCategoryColor(tx.category)">
                    {{ tx.category.substring(0,1) }}
                </div>
                <div class="overflow-hidden">
                    <div class="font-bold text-gray-800 truncate">{{ tx.note || tx.category }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ tx.date }} • {{ tx.user }} • {{ tx.account }}</div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="font-bold text-lg" :class="tx.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                    {{ formatMoney(tx.amount) }}
                </div>
                <button @click="deleteTransaction(index)" class="text-xs text-red-400 underline mt-1">刪除</button>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'add'" class="px-6 pb-20">
        <h2 class="text-xl font-bold mb-4 text-gray-700">新增交易</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-600 mb-1">日期</label>
                <input type="date" v-model="newTx.date" class="w-full p-3 border rounded-lg bg-white">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">使用者</label>
                    <select v-model="newTx.user" class="w-full p-3 border rounded-lg bg-white">
                        <option v-for="u in options.users" :value="u">{{ u }}</
