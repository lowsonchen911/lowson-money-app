<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家庭記帳 (雲端共用版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .app-container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; position: relative; }
        /* Loading 遮罩 */
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 50; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col">
    
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner mb-2"></div>
        <div class="text-slate-600 font-bold">資料同步中...</div>
    </div>

    <header class="bg-slate-800 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
        <div class="flex items-center gap-2">
            <h1 class="text-lg font-bold">家庭記帳</h1>
            <span class="text-xs bg-blue-600 px-2 py-0.5 rounded-full">雲端版</span>
        </div>
        <button @click="fetchData" class="text-xs border border-white px-2 py-1 rounded hover:bg-slate-700">
            ↻ 重新整理
        </button>
    </header>

    <div v-if="currentTab !== 'settings'" class="p-4 bg-slate-800 text-white rounded-b-3xl shadow-lg mb-4">
        <div class="text-slate-400 text-sm">目前總資產 (全家人)</div>
        <div class="text-4xl font-bold my-2">{{ formatMoney(totalAssets) }}</div>
        <div class="flex gap-2 mt-4 overflow-x-auto pb-2 no-scrollbar">
            <div v-for="(balance, acc) in accountBalances" :key="acc" class="bg-slate-700 px-3 py-2 rounded-lg min-w-[120px] flex-shrink-0">
                <div class="text-xs text-slate-300 truncate">{{ acc }}</div>
                <div class="font-semibold" :class="balance < 0 ? 'text-red-400' : 'text-green-400'">{{ formatMoney(balance) }}</div>
            </div>
        </div>
    </div>

    <div class="flex justify-center gap-2 mb-4 px-4">
        <button @click="currentTab = 'list'" :class="currentTab === 'list' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">列表</button>
        <button @click="currentTab = 'add'" :class="currentTab === 'add' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">記一筆</button>
        <button @click="currentTab = 'chart'" :class="currentTab === 'chart' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">報表</button>
        <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">設定</button>
    </div>

    <div v-if="currentTab === 'list'" class="flex-1 overflow-y-auto px-4 pb-20">
        <div v-if="transactions.length === 0" class="text-center text-gray-400 mt-10">
            目前沒有資料，或正在讀取中...
        </div>
        <div v-for="(tx, index) in sortedTransactions" :key="index" class="bg-white border-b border-gray-100 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                     :class="getCategoryColor(tx.category)">
                    {{ tx.category.substring(0,1) }}
                </div>
                <div class="overflow-hidden">
                    <div class="font-bold text-gray-800 truncate">{{ tx.note || tx.category }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ tx.date }} • {{ tx.user }} • {{ tx.account }}</div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="font-bold text-lg" :class="tx.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                    {{ formatMoney(tx.amount) }}
                </div>
            </div>
        </div>
        <div class="text-center text-xs text-gray-400 mt-4 mb-8">
            欲刪除或修改資料，請直接編輯 Google Sheet<br>(確保資料安全)
        </div>
    </div>

    <div v-if="currentTab === 'add'" class="px-6 pb-20">
        <h2 class="text-xl font-bold mb-4 text-gray-700">新增交易</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-600 mb-1">日期</label>
                <input type="date" v-model="newTx.date" class="w-full p-3 border rounded-lg bg-white">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">使用者</label>
                    <select v-model="newTx.user" class="w-full p-3 border rounded-lg bg-white">
                        <option v-for="u in options.users" :value="u">{{ u }}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">帳戶</label>
                    <select v-model="newTx.account" class="w-full p-3 border rounded-lg bg-white">
                        <option v-for="a in options.accounts" :value="a">{{ a }}</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">交易類別</label>
                <select v-model="newTx.category" class="w-full p-3 border rounded-lg bg-white">
                    <option v-for="c in options.categories" :value="c">{{ c }}</option>
                </select>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">金額 (正數收入，負數支出)</label>
                <input type="number" v-model.number="newTx.amount" class="w-full p-3 border rounded-lg bg-white text-xl" placeholder="-100">
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">備註說明</label>
                <input type="text" v-model="newTx.note" class="w-full p-3 border rounded-lg bg-white" placeholder="例如：吃午餐">
            </div>

            <button @click="addTransaction" class="w-full bg-slate-800 text-white py-4 rounded-lg text-lg font-bold shadow-lg mt-4 active:bg-slate-900">
                儲存到雲端
            </button>
        </div>
    </div>

    <div v-show="currentTab === 'chart'" class="px-4 pb-20 pt-4">
        <div class="bg-white p-4 rounded-xl shadow mb-4">
            <h3 class="font-bold text-gray-700 mb-4 text-center">資產分佈 (帳戶餘額)</h3>
            <canvas id="assetChart"></canvas>
        </div>
    </div>

    <div v-if="currentTab === 'settings'" class="px-4 pb-20">
        <h2 class="text-xl font-bold mb-4 text-gray-700 mt-4">選項設定 (同步至雲端)</h2>
        
        <div v-for="(list, key) in optionLabels" :key="key" class="mb-6 bg-white p-4 rounded-lg shadow-sm border">
            <h3 class="font-bold text-slate-700 mb-2 border-b pb-2">{{ list.title }}</h3>
            <div class="flex flex-wrap gap-2 mb-3">
                <div v-for="(item, idx) in options[key]" :key="idx" class="bg-gray-100 px-3 py-1 rounded-full flex items-center gap-2 text-sm">
                    {{ item }}
                    <button @click="removeItem(key, idx)" class="text-red-400 hover:text-red-600 font-bold px-1">×</button>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" v-model="tempInput[key]" :placeholder="'新增' + list.title" class="flex-1 border rounded px-3 py-2 text-sm">
                <button @click="addItem(key)" class="bg-slate-700 text-white px-4 py-2 rounded text-sm">新增</button>
            </div>
        </div>
        
        <button @click="saveOptionsToCloud" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mb-8">
            儲存設定變更
        </button>
    </div>

</div>

<script>
    // ==========================================
    // 請在這裡貼上你的 Google Apps Script 網址
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyzm0YIaIn3wg9ethT2gecbamUzFRCrTUEv9QpES5RF6hAcHYvaTL1Z7M5s7YVLzOl5/exec"; 
    // 例如: "https://script.google.com/macros/s/xxxxxxxxx/exec"


    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isLoading: false,
                currentTab: 'list',
                // 預設選項 (若雲端沒資料會用這個)
                options: {
                    users: ['lowson', 'wisdom'],
                    accounts: ['現金', '中信薪轉帳戶', '彰銀房貸帳戶', '富邦cube信用卡'],
                    categories: ['餐飲支出', '提款轉帳', '薪資獎金']
                },
                optionLabels: {
                    users: { title: '使用者' },
                    accounts: { title: '帳戶' },
                    categories: { title: '交易類別' }
                },
                tempInput: { users: '', accounts: '', categories: '' },
                
                transactions: [],
                
                newTx: {
                    date: new Date().toISOString().split('T')[0],
                    user: 'wisdom',
                    account: '現金',
                    category: '餐飲支出',
                    amount: null,
                    note: ''
                },
                chartInstance: null
            }
        },
        computed: {
            sortedTransactions() {
                return [...this.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            totalAssets() {
                return this.transactions.reduce((sum, t) => sum + t.amount, 0);
            },
            accountBalances() {
                const bals = {};
                this.options.accounts.forEach(acc => bals[acc] = 0);
                this.transactions.forEach(t => {
                    bals[t.account] = (bals[t.account] || 0) + t.amount;
                });
                return bals;
            }
        },
        mounted() {
            // App 啟動時讀取雲端資料
            this.fetchData();
        },
        watch: {
            currentTab(val) {
                if (val === 'chart') {
                    this.$nextTick(() => this.renderChart());
                }
            }
        },
        methods: {
            formatMoney(val) {
                return '$' + val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            },
            
            // --- 核心功能：讀取資料 ---
            fetchData() {
                if(GAS_URL.includes("你的_GOOGLE")) {
                    alert("請先修改程式碼中的 GAS_URL 為你的部署網址！");
                    return;
                }
                this.isLoading = true;
                fetch(GAS_URL)
                    .then(response => response.json())
                    .then(data => {
                        this.transactions = data.transactions;
                        if (data.options) {
                            this.options = data.options;
                        }
                        this.renderChart();
                        this.isLoading = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("讀取失敗，請檢查網路或網址設定");
                        this.isLoading = false;
                    });
            },

            // --- 核心功能：新增資料 ---
            addTransaction() {
                if (!this.newTx.amount) return alert('請輸入金額');
                
                this.isLoading = true;
                // 使用 sendBeacon 比較快，但為了確保成功我們用 fetch POST
                const payload = { ...this.newTx };
                
                fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // 重要：避免跨域錯誤，但會拿不到回傳值
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add_tx', payload: payload })
                }).then(() => {
                    // 因為 no-cors 拿不到回傳，我們假設成功並直接更新本地畫面
                    this.transactions.push(payload); 
                    this.newTx.amount = null;
                    this.newTx.note = '';
                    alert('記帳成功！(已背景同步)');
                    this.currentTab = 'list';
                    this.isLoading = false;
                    // 為了保險，稍後偷偷重新整理一次
                    setTimeout(() => this.fetchData(), 1000); 
                }).catch(err => {
                    alert('連線錯誤');
                    this.isLoading = false;
                });
            },

            // --- 設定功能 ---
            addItem(key) {
                const val = this.tempInput[key].trim();
                if (!val) return;
                if (this.options[key].includes(val)) return alert('該項目已存在');
                this.options[key].push(val);
                this.tempInput[key] = ''; 
            },
            removeItem(key, idx) {
                if (confirm('確定要刪除此選項嗎？')) {
                    this.options[key].splice(idx, 1);
                }
            },
            saveOptionsToCloud() {
                this.isLoading = true;
                fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'update_options', payload: this.options })
                }).then(() => {
                    alert("設定已更新至雲端！");
                    this.isLoading = false;
                });
            },

            // --- 樣式與圖表 ---
            getCategoryColor(cat) {
                if (cat.includes('支出') || cat.includes('費') || cat.includes('水電')) return 'bg-red-400';
                if (cat.includes('薪資') || cat.includes('收入') || cat.includes('獎金')) return 'bg-green-500';
                return 'bg-blue-400';
            },
            renderChart() {
                const ctx = document.getElementById('assetChart');
                if (!ctx) return;
                const labels = Object.keys(this.accountBalances).filter(k => this.accountBalances[k] !== 0);
                const data = labels.map(k => this.accountBalances[k]);
                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#6366f1', '#8b5cf6', '#ec4899'];
                if (this.chartInstance) this.chartInstance.destroy();
                this.chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{ data: data, backgroundColor: colors, hoverOffset: 4 }]
                    }
                });
            }
        }
    });
</script>
</body>
</html>
