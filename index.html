<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>W & L 記帳理財</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIldpc2RvbSAmIExvd3NvbiBGaW5hbmNlIiwKICAic2hvcnRfbmFtZSI6ICJXJkwgRmluYW5jZSIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjNEY0NkU1IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4tYWljb25zLWljb25zOGljb24uY29tL3Avc2hvcnRjdXQtaWNvbi5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (Version Locked) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts (Version Locked) -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select { font-size: 16px; } /* Prevent zoom on iOS */
        #error-display { display: none; padding: 20px; background: #fee2e2; color: #b91c1c; border: 1px solid #ef4444; margin: 20px; border-radius: 8px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-display"></div>

    <!-- Error Handler Script -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const el = document.getElementById('error-display');
            el.style.display = 'block';
            el.innerHTML = `<strong>App 發生錯誤：</strong><br>${message}<br><small>Line: ${lineno}</small>`;
            console.error(error);
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } = Recharts;

        // --- Internal Icons (Replaces External Dependency) ---
        // 定義簡單的 SVG 組件以避免依賴外部庫導致的載入錯誤
        const Icons = {
            Wallet: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            PieChart: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            PlusCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>,
            RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            DollarSign: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Home: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
        };

        // --- Configuration ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxaLCRi_esPgVMxeBMGxdlryWpIYa6vlj6AbB3M_Qg0mTH5x0GlZRGAH1GZ9RcoE0di/exec";
        
        // Mock Real-time Prices
        const MARKET_PRICES = {
            "00937B": 15.8, "00945B": 15.2, "00953B": 10.5, "00981B": 10.1, "0050": 165.0
        };

        const USERS = ["Wisdom", "Lowson"];
        const ACCOUNTS = ["現金", "中信薪轉帳戶", "彰銀房貸帳戶", "永豐股票帳戶"];
        const INV_ACCOUNTS = ["永豐股票帳戶", "凱基債劵帳戶", "永豐債劵帳戶"];
        const ASSET_NAMES = ["00937B", "00945B", "00953B", "00981B", "0050"];
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

        function App() {
            const [view, setView] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [submitStatus, setSubmitStatus] = useState(null);

            // --- Data Fetching ---
            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${GAS_URL}?t=${new Date().getTime()}`);
                    const data = await response.json();
                    setTransactions(data.reverse());
                } catch (error) {
                    console.error("Fetch Error", error);
                    // Mock data for initial render if fetch fails
                    if (transactions.length === 0) {
                        setTransactions([
                            { user: "Wisdom", type: "收入", account: "中信薪轉帳戶", category: "薪資獎金", amount: 50000, note: "預設測試資料", timestamp: new Date().toISOString() },
                            { user: "Wisdom", type: "支出", account: "現金", category: "餐飲支出", amount: 120, note: "測試午餐", timestamp: new Date().toISOString() }
                        ]);
                    }
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchData();
            }, []);

            // --- Form State ---
            const initialForm = {
                user: "Wisdom", type: "支出", account: "現金", toAccount: "現金", category: "餐飲支出",
                assetName: "00981B", assetQty: "", assetPrice: "", amount: "", note: ""
            };
            const [formData, setFormData] = useState(initialForm);

            // --- Form Handlers ---
            const handleTypeChange = (e) => {
                const newType = e.target.value;
                let updates = { type: newType };
                if (newType === "收入") { updates.account = "中信薪轉帳戶"; updates.category = "薪資獎金"; } 
                else if (newType === "支出") { updates.account = "現金"; updates.category = "餐飲支出"; } 
                else if (newType === "提款轉帳") { updates.account = "中信薪轉帳戶"; updates.toAccount = "現金"; updates.category = "提款"; } 
                else if (newType === "資產投資") { updates.account = "凱基債劵帳戶"; updates.assetName = "00981B"; }
                setFormData({ ...formData, ...updates });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitStatus("submitting");
                
                let finalData = { ...formData };
                if (finalData.type === "資產投資") {
                    finalData.amount = parseFloat(finalData.assetQty) * parseFloat(finalData.assetPrice);
                }
                
                // Optimistic UI Update
                const newTx = { ...finalData, amount: parseFloat(finalData.amount), timestamp: new Date().toISOString() };
                setTransactions([newTx, ...transactions]);

                try {
                    await fetch(GAS_URL, {
                        method: "POST", mode: "no-cors",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(finalData)
                    });
                    setSubmitStatus("success");
                    setFormData(initialForm);
                    setTimeout(() => setSubmitStatus(null), 2000);
                } catch (error) {
                    console.error("Submit Error", error);
                    setSubmitStatus("error");
                }
            };

            // --- Calculations ---
            const accountBalances = useMemo(() => {
                const bals = {};
                ACCOUNTS.concat(INV_ACCOUNTS).forEach(acc => bals[acc] = 0);
                transactions.forEach(t => {
                    const amt = parseFloat(t.amount || 0);
                    if (t.type === "收入") bals[t.account] = (bals[t.account] || 0) + amt;
                    else if (t.type === "支出") bals[t.account] = (bals[t.account] || 0) - amt;
                    else if (t.type === "提款轉帳") { bals[t.account] -= amt; bals[t.toAccount] = (bals[t.toAccount] || 0) + amt; }
                    else if (t.type === "資產投資") bals[t.account] -= amt;
                });
                return bals;
            }, [transactions]);

            const portfolio = useMemo(() => {
                const port = {};
                transactions.filter(t => t.type === "資產投資").forEach(t => {
                    if (!port[t.assetName]) port[t.assetName] = { qty: 0, cost: 0 };
                    port[t.assetName].qty += parseFloat(t.assetQty);
                    port[t.assetName].cost += parseFloat(t.amount);
                });
                return Object.keys(port).map(name => {
                    const item = port[name];
                    const val = item.qty * (MARKET_PRICES[name] || 0);
                    const prof = val - item.cost;
                    return { name, qty: item.qty, cost: item.cost, value: val, profit: prof, profitPercent: item.cost ? (prof/item.cost)*100 : 0 };
                });
            }, [transactions]);

            const monthlyStats = useMemo(() => {
                const stats = { income: 0, expense: 0 };
                const now = new Date();
                transactions.forEach(t => {
                    const d = new Date(t.timestamp);
                    if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                        if (t.type === "收入") stats.income += parseFloat(t.amount);
                        if (t.type === "支出") stats.expense += parseFloat(t.amount);
                    }
                });
                return stats;
            }, [transactions]);

            // --- Render Components ---
            const renderDashboard = () => (
                <div className="space-y-6 pb-24">
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-3xl shadow-lg text-white">
                        <div className="flex justify-between items-center mb-4">
                            <div><h2 className="text-sm opacity-80">本月支出</h2><p className="text-3xl font-bold">${monthlyStats.expense.toLocaleString()}</p></div>
                            <div className="text-right"><h2 className="text-sm opacity-80">本月收入</h2><p className="text-2xl font-semibold text-green-300">${monthlyStats.income.toLocaleString()}</p></div>
                        </div>
                        <div className="pt-4 border-t border-white/20">
                            <span className="text-xs block opacity-70">總資產價值 (估算)</span>
                            <span className="text-lg font-medium">${Math.round(portfolio.reduce((s, p) => s + p.value, 0) + Object.values(accountBalances).reduce((a,b)=>a+b,0)).toLocaleString()}</span>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-gray-700 font-bold mb-3 px-2 flex items-center"><Icons.Wallet className="w-5 h-5 mr-2 text-indigo-500" /> 帳戶餘額</h3>
                        <div className="grid grid-cols-2 gap-3">
                            {ACCOUNTS.map(acc => (
                                <div key={acc} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                    <p className="text-xs text-gray-500 mb-1">{acc}</p>
                                    <p className="text-lg font-bold text-gray-800">${accountBalances[acc]?.toLocaleString()}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div>
                        <h3 className="text-gray-700 font-bold mb-3 px-2 flex items-center"><Icons.TrendingUp className="w-5 h-5 mr-2 text-indigo-500" /> 重點資產</h3>
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
                            {portfolio.slice(0, 3).map((item, idx) => (
                                <div key={idx} className="flex justify-between items-center p-4 border-b border-gray-100 last:border-0">
                                    <div><p className="font-bold text-gray-800">{item.name}</p><p className="text-xs text-gray-500">{item.qty} 單位</p></div>
                                    <div className="text-right"><p className="font-medium">${Math.round(item.value).toLocaleString()}</p><p className={`text-xs ${item.profit >= 0 ? 'text-red-500' : 'text-green-500'}`}>{item.profit >= 0 ? '+' : ''}{item.profitPercent.toFixed(2)}%</p></div>
                                </div>
                            ))}
                            {portfolio.length === 0 && <p className="p-4 text-center text-gray-400 text-sm">暫無投資紀錄</p>}
                        </div>
                    </div>
                </div>
            );

            const renderAddTransaction = () => (
                <div className="pb-24">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 px-2">新增記帳</h2>
                    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-3xl shadow-sm space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">使用者</label>
                            <div className="flex bg-gray-100 rounded-xl p-1">
                                {USERS.map(u => (
                                    <button type="button" key={u} onClick={() => setFormData({...formData, user: u})} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${formData.user === u ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>{u}</button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-500 mb-1">交易方式</label>
                            <select value={formData.type} onChange={handleTypeChange} className="w-full p-3 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-200">
                                <option value="支出">支出</option><option value="收入">收入</option><option value="提款轉帳">提款轉帳</option><option value="資產投資">資產投資</option>
                            </select>
                        </div>
                        
                        {/* Dynamic Fields */}
                        {formData.type === "收入" && (
                            <>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">存入帳戶</label><select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">類別</label><select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{["薪資獎金", "股票股利", "債卷配息"].map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                            </>
                        )}
                        {formData.type === "支出" && (
                            <>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">支付帳戶</label><select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">類別</label><select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{["餐飲支出", "水電瓦斯", "生活用品", "休閒旅遊", "醫療保險"].map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                            </>
                        )}
                        {formData.type === "提款轉帳" && (
                            <>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-500 mb-1">轉出帳戶</label><select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl text-sm">{ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                                    <div><label className="block text-sm font-medium text-gray-500 mb-1">轉入帳戶</label><select value={formData.toAccount} onChange={(e) => setFormData({...formData, toAccount: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl text-sm">{ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                                </div>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">類別</label><select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{["提款", "轉帳", "繳卡費", "繳貸款"].map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                            </>
                        )}
                        {formData.type === "資產投資" && (
                            <>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">扣款帳戶</label><select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{INV_ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                                <div><label className="block text-sm font-medium text-gray-500 mb-1">資產名稱</label><select value={formData.assetName} onChange={(e) => setFormData({...formData, assetName: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">{ASSET_NAMES.map(a => <option key={a} value={a}>{a}</option>)}</select></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium text-gray-500 mb-1">數量</label><input type="number" value={formData.assetQty} onChange={(e) => setFormData({...formData, assetQty: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" placeholder="股/張" /></div>
                                    <div><label className="block text-sm font-medium text-gray-500 mb-1">單價</label><input type="number" value={formData.assetPrice} onChange={(e) => setFormData({...formData, assetPrice: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" placeholder="$" /></div>
                                </div>
                                <div className="text-right text-sm text-gray-500">試算金額: <span className="font-bold text-gray-800">${(parseFloat(formData.assetQty || 0) * parseFloat(formData.assetPrice || 0)).toLocaleString()}</span></div>
                            </>
                        )}

                        {formData.type !== "資產投資" && (
                            <div>
                                <label className="block text-sm font-medium text-gray-500 mb-1">金額</label>
                                <div className="relative">
                                    <div className="absolute left-3 top-3.5 w-5 h-5 text-gray-400 flex items-center justify-center"><Icons.DollarSign className="w-5 h-5"/></div>
                                    <input type="number" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} className="w-full pl-10 p-3 bg-gray-50 rounded-xl font-bold text-lg" placeholder="0" required />
                                </div>
                            </div>
                        )}
                        <div><label className="block text-sm font-medium text-gray-500 mb-1">備註</label><input type="text" value={formData.note} onChange={(e) => setFormData({...formData, note: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" placeholder="選填..." /></div>

                        <button type="submit" disabled={submitStatus === "submitting"} className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform flex justify-center items-center">
                            {submitStatus === "submitting" ? <Icons.RefreshCw className="animate-spin w-5 h-5" /> : "儲存交易"}
                        </button>
                        {submitStatus === "success" && <p className="text-center text-green-500">儲存成功！</p>}
                        {submitStatus === "error" && <p className="text-center text-red-500">儲存失敗，請重試。</p>}
                    </form>
                </div>
            );

            const renderAssets = () => (
                <div className="pb-24">
                    <h2 className="text-xl font-bold text-gray-800 mb-6 px-2">資產總表</h2>
                    <div className="bg-white rounded-3xl shadow-sm overflow-hidden">
                        <table className="w-full text-left border-collapse">
                            <thead><tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider"><th className="p-4 font-medium">名稱</th><th className="p-4 font-medium text-right">數量</th><th className="p-4 font-medium text-right">市價/損益</th><th className="p-4 font-medium text-right">報酬率</th></tr></thead>
                            <tbody className="divide-y divide-gray-100">
                                {portfolio.map((item, idx) => (
                                    <tr key={idx} className="hover:bg-gray-50 transition-colors">
                                        <td className="p-4"><div className="font-bold text-gray-800">{item.name}</div><div className="text-xs text-gray-400">成本: {Math.round(item.cost/item.qty).toLocaleString()}</div></td>
                                        <td className="p-4 text-right font-medium text-gray-700">{item.qty.toLocaleString()}</td>
                                        <td className="p-4 text-right"><div className="font-bold text-gray-800">${Math.round(item.value).toLocaleString()}</div><div className={`text-xs font-bold ${item.profit >= 0 ? 'text-red-500' : 'text-green-500'}`}>{item.profit >= 0 ? '+' : ''}{Math.round(item.profit).toLocaleString()}</div></td>
                                        <td className="p-4 text-right"><span className={`inline-block px-2 py-1 rounded text-xs font-bold ${item.profit >= 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{item.profitPercent.toFixed(1)}%</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {portfolio.length === 0 && <div className="p-8 text-center text-gray-400">目前無資產投資紀錄</div>}
                    </div>
                </div>
            );

            const renderAnalysis = () => {
                const expenseData = transactions.filter(t => t.type === "支出").reduce((acc, curr) => {
                    const existing = acc.find(i => i.name === curr.category);
                    if (existing) existing.value += parseFloat(curr.amount);
                    else acc.push({ name: curr.category, value: parseFloat(curr.amount) });
                    return acc;
                }, []);
                return (
                    <div className="pb-24 space-y-6">
                        <h2 className="text-xl font-bold text-gray-800 px-2">統計分析</h2>
                        <div className="bg-white p-6 rounded-3xl shadow-sm">
                            <h3 className="font-bold text-gray-700 mb-4">支出類別分佈</h3>
                            <div className="h-64">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={expenseData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} fill="#8884d8" paddingAngle={5} dataKey="value">
                                            {expenseData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                        </Pie>
                                        <Tooltip formatter={(value) => `$${value.toLocaleString()}`} />
                                        <Legend />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                            {expenseData.length === 0 && <p className="text-center text-gray-400 text-sm">尚無支出資料</p>}
                        </div>
                    </div>
                );
            };

            const NavItem = ({ id, icon: Icon, label }) => (
                <button onClick={() => setView(id)} className={`flex flex-col items-center justify-center w-full h-full space-y-1 ${view === id ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}>
                    <Icon className="w-6 h-6" strokeWidth={view === id ? 2.5 : 2} />
                    <span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            return (
                <div className="min-h-screen max-w-md mx-auto bg-gray-50 relative shadow-2xl">
                    <header className="bg-white/80 backdrop-blur-md sticky top-0 z-10 px-6 py-4 flex justify-between items-center border-b border-gray-100">
                        <div className="flex items-center space-x-2"><div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">W</div><h1 className="font-bold text-gray-800 text-lg">W & L 記帳</h1></div>
                        <button onClick={fetchData} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"><Icons.RefreshCw className={`w-4 h-4 text-gray-600 ${loading ? 'animate-spin' : ''}`} /></button>
                    </header>
                    <main className="p-4 min-h-[80vh]">
                        {view === 'dashboard' && renderDashboard()}
                        {view === 'add' && renderAddTransaction()}
                        {view === 'assets' && renderAssets()}
                        {view === 'analysis' && renderAnalysis()}
                    </main>
                    <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 h-20 pb-4 z-20 flex justify-around items-center px-2">
                        <NavItem id="dashboard" icon={Icons.Home} label="總覽" />
                        <NavItem id="add" icon={Icons.PlusCircle} label="記帳" />
                        <NavItem id="assets" icon={Icons.TrendingUp} label="資產" />
                        <NavItem id="analysis" icon={Icons.PieChart} label="分析" />
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
