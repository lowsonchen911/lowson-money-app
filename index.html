import React, { useState, useEffect, useMemo } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';
import { 
  PlusCircle, 
  Wallet, 
  TrendingUp, 
  PieChart as PieChartIcon, 
  RefreshCw, 
  DollarSign, 
  Home, 
  ArrowRightLeft,
  Save,
  WifiOff
} from 'lucide-react';

// --- Configuration ---
const GAS_URL = "https://script.google.com/macros/s/AKfycbxaLCRi_esPgVMxeBMGxdlryWpIYa6vlj6AbB3M_Qg0mTH5x0GlZRGAH1GZ9RcoE0di/exec";

// Mock Real-time Prices (模擬即時股價)
const MARKET_PRICES = {
  "00937B": 15.8,
  "00945B": 15.2,
  "00953B": 10.5,
  "00981B": 10.1,
  "0050": 165.0
};

const USERS = ["Wisdom", "Lowson"];
const ACCOUNTS = ["現金", "中信薪轉帳戶", "彰銀房貸帳戶", "永豐股票帳戶"];
const INV_ACCOUNTS = ["永豐股票帳戶", "凱基債劵帳戶", "永豐債劵帳戶"];
const ASSET_NAMES = ["00937B", "00945B", "00953B", "00981B", "0050"];
const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

export default function App() {
  const [view, setView] = useState('dashboard');
  const [transactions, setTransactions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [submitStatus, setSubmitStatus] = useState(null);
  const [isOffline, setIsOffline] = useState(false);

  // --- PWA Manifest Injection ---
  useEffect(() => {
    const manifestLink = document.createElement('link');
    manifestLink.rel = 'manifest';
    const manifestData = {
      "name": "Wisdom & Lowson Finance",
      "short_name": "W&L Fin",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#ffffff",
      "theme_color": "#4F46E5",
      "icons": [
        {
          "src": "https://cdn-icons-png.flaticon.com/512/2382/2382461.png", 
          "sizes": "192x192",
          "type": "image/png"
        }
      ]
    };
    manifestLink.href = 'data:application/json;base64,' + btoa(JSON.stringify(manifestData));
    document.head.appendChild(manifestLink);
    
    // Viewport meta fix for mobile
    let viewport = document.querySelector('meta[name="viewport"]');
    if (!viewport) {
      viewport = document.createElement('meta');
      viewport.name = "viewport";
      document.head.appendChild(viewport);
    }
    viewport.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no";
  }, []);

  // --- Data Fetching ---
  const fetchData = async () => {
    setLoading(true);
    setIsOffline(false);
    try {
      // Attempt to fetch from Google Sheets
      const response = await fetch(`${GAS_URL}?t=${new Date().getTime()}`, {
        method: 'GET',
        // credentials: 'omit' // Helps with some redirect issues
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      setTransactions(data.reverse()); 
    } catch (error) {
      console.warn("Fetching from Google Sheets failed (likely CORS or permissions). Using Mock Data.", error);
      setIsOffline(true);
      
      // Fallback Mock Data (so the app is usable in demo/offline)
      if (transactions.length === 0) {
        setTransactions([
          { user: "Wisdom", type: "收入", account: "中信薪轉帳戶", category: "薪資獎金", amount: 50000, note: "模擬資料: 薪資", timestamp: new Date().toISOString() },
          { user: "Wisdom", type: "支出", account: "現金", category: "餐飲支出", amount: 120, note: "模擬資料: 午餐", timestamp: new Date().toISOString() },
          { user: "Wisdom", type: "資產投資", account: "凱基債劵帳戶", assetName: "00937B", assetQty: 1000, assetPrice: 15.8, amount: 15800, note: "模擬資料: 定期定額", timestamp: new Date().toISOString() }
        ]);
      }
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // --- Form State ---
  const initialForm = {
    user: "Wisdom",
    type: "支出",
    account: "現金", 
    toAccount: "現金", 
    category: "餐飲支出",
    assetName: "00981B",
    assetQty: "",
    assetPrice: "",
    amount: "",
    note: ""
  };
  const [formData, setFormData] = useState(initialForm);

  // --- Form Handlers ---
  const handleTypeChange = (e) => {
    const newType = e.target.value;
    let updates = { type: newType };
    
    if (newType === "收入") {
      updates.account = "中信薪轉帳戶";
      updates.category = "薪資獎金";
    } else if (newType === "支出") {
      updates.account = "現金";
      updates.category = "餐飲支出";
    } else if (newType === "提款轉帳") {
      updates.account = "中信薪轉帳戶";
      updates.toAccount = "現金";
      updates.category = "提款";
    } else if (newType === "資產投資") {
      updates.account = "凱基債劵帳戶";
      updates.assetName = "00981B";
    }
    setFormData({ ...formData, ...updates });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitStatus("submitting");
    
    let finalData = { ...formData };
    if (finalData.type === "資產投資") {
      finalData.amount = parseFloat(finalData.assetQty || 0) * parseFloat(finalData.assetPrice || 0);
    }
    
    // Optimistic UI Update
    const newTx = {
      ...finalData,
      amount: parseFloat(finalData.amount),
      timestamp: new Date().toISOString()
    };
    setTransactions([newTx, ...transactions]);

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors", // Important for GAS POST requests
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(finalData)
      });
      
      setSubmitStatus("success");
      setFormData(initialForm); 
      setTimeout(() => setSubmitStatus(null), 2000);
    } catch (error) {
      console.error("Submit Error", error);
      // Even if fetch fails (e.g. network error), we keep the optimistic update for the user session
      setSubmitStatus("success"); // Pretend success in offline mode
      setTimeout(() => setSubmitStatus(null), 2000);
    }
  };

  // --- Calculations ---
  const accountBalances = useMemo(() => {
    const bals = {};
    [...ACCOUNTS, ...INV_ACCOUNTS].forEach(acc => bals[acc] = 0);

    transactions.forEach(t => {
      const amt = parseFloat(t.amount || 0);
      if (t.type === "收入") {
        bals[t.account] = (bals[t.account] || 0) + amt;
      } else if (t.type === "支出") {
        bals[t.account] = (bals[t.account] || 0) - amt;
      } else if (t.type === "提款轉帳") {
        bals[t.account] = (bals[t.account] || 0) - amt;
        bals[t.toAccount] = (bals[t.toAccount] || 0) + amt;
      } else if (t.type === "資產投資") {
        bals[t.account] = (bals[t.account] || 0) - amt;
      }
    });
    return bals;
  }, [transactions]);

  const portfolio = useMemo(() => {
    const port = {};
    transactions.filter(t => t.type === "資產投資").forEach(t => {
      if (!port[t.assetName]) {
        port[t.assetName] = { qty: 0, cost: 0 };
      }
      port[t.assetName].qty += parseFloat(t.assetQty);
      port[t.assetName].cost += parseFloat(t.amount);
    });

    return Object.keys(port).map(name => {
      const item = port[name];
      const currentPrice = MARKET_PRICES[name] || 0;
      const currentValue = item.qty * currentPrice;
      const profit = currentValue - item.cost;
      const profitPercent = item.cost > 0 ? (profit / item.cost) * 100 : 0;
      
      return {
        name,
        qty: item.qty,
        cost: item.cost,
        value: currentValue,
        profit,
        profitPercent
      };
    });
  }, [transactions]);

  const monthlyStats = useMemo(() => {
    const stats = { income: 0, expense: 0 };
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    transactions.forEach(t => {
      const date = new Date(t.timestamp);
      if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
        if (t.type === "收入") stats.income += parseFloat(t.amount);
        if (t.type === "支出") stats.expense += parseFloat(t.amount);
      }
    });
    return stats;
  }, [transactions]);

  // --- Render Views ---

  const renderDashboard = () => (
    <div className="space-y-6 pb-24 animate-fade-in">
      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-3xl shadow-lg text-white">
        <div className="flex justify-between items-center mb-4">
          <div>
            <h2 className="text-sm opacity-80">本月支出</h2>
            <p className="text-3xl font-bold">${monthlyStats.expense.toLocaleString()}</p>
          </div>
          <div className="text-right">
            <h2 className="text-sm opacity-80">本月收入</h2>
            <p className="text-2xl font-semibold text-green-300">${monthlyStats.income.toLocaleString()}</p>
          </div>
        </div>
        <div className="pt-4 border-t border-white/20 flex justify-between items-center">
          <div>
            <span className="text-xs block opacity-70">總資產價值 (估算)</span>
            <span className="text-lg font-medium">
              ${Math.round(portfolio.reduce((sum, p) => sum + p.value, 0) + Object.values(accountBalances).reduce((a,b)=>a+b,0)).toLocaleString()}
            </span>
          </div>
          {isOffline && (
            <div className="flex items-center bg-white/20 px-2 py-1 rounded text-xs">
              <WifiOff size={12} className="mr-1" /> 離線模式
            </div>
          )}
        </div>
      </div>

      <div>
        <h3 className="text-gray-700 font-bold mb-3 px-2 flex items-center">
          <Wallet className="w-5 h-5 mr-2 text-indigo-500" /> 帳戶餘額
        </h3>
        <div className="grid grid-cols-2 gap-3">
          {ACCOUNTS.map(acc => (
            <div key={acc} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
              <p className="text-xs text-gray-500 mb-1">{acc}</p>
              <p className="text-lg font-bold text-gray-800">${accountBalances[acc]?.toLocaleString()}</p>
            </div>
          ))}
        </div>
      </div>

      <div>
        <h3 className="text-gray-700 font-bold mb-3 px-2 flex items-center">
          <TrendingUp className="w-5 h-5 mr-2 text-indigo-500" /> 重點資產
        </h3>
        <div className="bg-white rounded-2xl shadow-sm overflow-hidden">
          {portfolio.slice(0, 3).map((item, idx) => (
            <div key={idx} className="flex justify-between items-center p-4 border-b border-gray-100 last:border-0">
              <div>
                <p className="font-bold text-gray-800">{item.name}</p>
                <p className="text-xs text-gray-500">{item.qty} 單位</p>
              </div>
              <div className="text-right">
                <p className="font-medium">${Math.round(item.value).toLocaleString()}</p>
                <p className={`text-xs ${item.profit >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                  {item.profit >= 0 ? '+' : ''}{item.profitPercent.toFixed(2)}%
                </p>
              </div>
            </div>
          ))}
          {portfolio.length === 0 && <p className="p-4 text-center text-gray-400 text-sm">暫無投資紀錄</p>}
        </div>
      </div>
    </div>
  );

  const renderAddTransaction = () => (
    <div className="pb-24 animate-fade-in">
      <h2 className="text-xl font-bold text-gray-800 mb-6 px-2">新增記帳</h2>
      <form onSubmit={handleSubmit} className="bg-white p-6 rounded-3xl shadow-sm space-y-4">
        
        {/* User */}
        <div>
          <label className="block text-sm font-medium text-gray-500 mb-1">使用者</label>
          <div className="flex bg-gray-100 rounded-xl p-1">
            {USERS.map(u => (
              <button
                type="button"
                key={u}
                onClick={() => setFormData({...formData, user: u})}
                className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${formData.user === u ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}
              >
                {u}
              </button>
            ))}
          </div>
        </div>

        {/* Type */}
        <div>
          <label className="block text-sm font-medium text-gray-500 mb-1">交易方式</label>
          <select 
            value={formData.type} 
            onChange={handleTypeChange}
            className="w-full p-3 bg-gray-50 rounded-xl border-none outline-none focus:ring-2 focus:ring-indigo-200"
          >
            <option value="支出">支出</option>
            <option value="收入">收入</option>
            <option value="提款轉帳">提款轉帳</option>
            <option value="資產投資">資產投資</option>
          </select>
        </div>

        {/* Dynamic Fields */}
        {formData.type === "收入" && (
          <>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">存入帳戶</label>
              <select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">類別</label>
              <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {["薪資獎金", "股票股利", "債卷配息"].map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          </>
        )}

        {formData.type === "支出" && (
          <>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">支付帳戶</label>
              <select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">類別</label>
              <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {["餐飲支出", "水電瓦斯", "生活用品", "休閒旅遊", "醫療保險"].map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          </>
        )}

        {formData.type === "提款轉帳" && (
          <>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-500 mb-1">轉出帳戶</label>
                <select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl text-sm">
                  {ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-500 mb-1">轉入帳戶</label>
                <select value={formData.toAccount} onChange={(e) => setFormData({...formData, toAccount: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl text-sm">
                  {ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}
                </select>
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">類別</label>
              <select value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {["提款", "轉帳", "繳卡費", "繳貸款"].map(c => <option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          </>
        )}

        {formData.type === "資產投資" && (
          <>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">扣款帳戶</label>
              <select value={formData.account} onChange={(e) => setFormData({...formData, account: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {INV_ACCOUNTS.map(a => <option key={a} value={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-500 mb-1">資產名稱</label>
              <select value={formData.assetName} onChange={(e) => setFormData({...formData, assetName: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl">
                {ASSET_NAMES.map(a => <option key={a} value={a}>{a}</option>)}
              </select>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-500 mb-1">數量</label>
                <input type="number" value={formData.assetQty} onChange={(e) => setFormData({...formData, assetQty: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" placeholder="股/張" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-500 mb-1">單價</label>
                <input type="number" value={formData.assetPrice} onChange={(e) => setFormData({...formData, assetPrice: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" placeholder="$" />
              </div>
            </div>
            <div className="text-right text-sm text-gray-500">
              試算金額: <span className="font-bold text-gray-800">${(parseFloat(formData.assetQty || 0) * parseFloat(formData.assetPrice || 0)).toLocaleString()}</span>
            </div>
          </>
        )}

        {formData.type !== "資產投資" && (
          <div>
            <label className="block text-sm font-medium text-gray-500 mb-1">金額</label>
            <div className="relative">
              <DollarSign className="absolute left-3 top-3.5 w-5 h-5 text-gray-400" />
              <input type="number" value={formData.amount} onChange={(e) => setFormData({...formData, amount: e.target.value})} className="w-full pl-10 p-3 bg-gray-50 rounded-xl font-bold text-lg" placeholder="0" required />
            </div>
          </div>
        )}
        
        <div>
          <label className="block text-sm font-medium text-gray-500 mb-1">備註</label>
          <input type="text" value={formData.note} onChange={(e) => setFormData({...formData, note: e.target.value})} className="w-full p-3 bg-gray-50 rounded-xl" placeholder="選填..." />
        </div>

        <button 
          type="submit" 
          disabled={submitStatus === "submitting"}
          className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-transform flex justify-center items-center"
        >
          {submitStatus === "submitting" ? <RefreshCw className="animate-spin" /> : "儲存交易"}
        </button>
        {submitStatus === "success" && <p className="text-center text-green-500">儲存成功！</p>}
        {submitStatus === "error" && <p className="text-center text-red-500">儲存失敗，請重試。</p>}
      </form>
    </div>
  );

  const renderAssets = () => (
    <div className="pb-24 animate-fade-in">
      <h2 className="text-xl font-bold text-gray-800 mb-6 px-2">資產總表</h2>
      <div className="bg-white rounded-3xl shadow-sm overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full text-left border-collapse">
            <thead>
              <tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                <th className="p-4 font-medium">名稱</th>
                <th className="p-4 font-medium text-right">數量</th>
                <th className="p-4 font-medium text-right">市價/損益</th>
                <th className="p-4 font-medium text-right">報酬率</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {portfolio.map((item, idx) => (
                <tr key={idx} className="hover:bg-gray-50 transition-colors">
                  <td className="p-4">
                    <div className="font-bold text-gray-800">{item.name}</div>
                    <div className="text-xs text-gray-400">成本: {Math.round(item.cost/item.qty).toLocaleString()}</div>
                  </td>
                  <td className="p-4 text-right font-medium text-gray-700">
                    {item.qty.toLocaleString()}
                  </td>
                  <td className="p-4 text-right">
                    <div className="font-bold text-gray-800">${Math.round(item.value).toLocaleString()}</div>
                    <div className={`text-xs font-bold ${item.profit >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                      {item.profit >= 0 ? '+' : ''}{Math.round(item.profit).toLocaleString()}
                    </div>
                  </td>
                  <td className="p-4 text-right">
                    <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${item.profit >= 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                      {item.profitPercent.toFixed(1)}%
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {portfolio.length === 0 && <div className="p-8 text-center text-gray-400">目前無資產投資紀錄</div>}
      </div>
    </div>
  );

  const renderAnalysis = () => {
    const expenseData = transactions
      .filter(t => t.type === "支出")
      .reduce((acc, curr) => {
        const existing = acc.find(i => i.name === curr.category);
        if (existing) existing.value += parseFloat(curr.amount);
        else acc.push({ name: curr.category, value: parseFloat(curr.amount) });
        return acc;
      }, []);

    return (
      <div className="pb-24 space-y-6 animate-fade-in">
        <h2 className="text-xl font-bold text-gray-800 px-2">統計分析</h2>
        <div className="bg-white p-6 rounded-3xl shadow-sm">
          <h3 className="font-bold text-gray-700 mb-4">支出類別分佈</h3>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie
                  data={expenseData}
                  cx="50%"
                  cy="50%"
                  innerRadius={60}
                  outerRadius={80}
                  fill="#8884d8"
                  paddingAngle={5}
                  dataKey="value"
                >
                  {expenseData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip formatter={(value) => `$${value.toLocaleString()}`} />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
          </div>
          {expenseData.length === 0 && <p className="text-center text-gray-400 text-sm">尚無支出資料</p>}
        </div>
      </div>
    );
  };

  const NavItem = ({ id, icon: Icon, label }) => (
    <button 
      onClick={() => setView(id)} 
      className={`flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors ${view === id ? 'text-indigo-600' : 'text-gray-400 hover:text-gray-600'}`}
    >
      <Icon size={24} strokeWidth={view === id ? 2.5 : 2} />
      <span className="text-[10px] font-medium">{label}</span>
    </button>
  );

  return (
    <div className="min-h-screen max-w-md mx-auto bg-gray-50 relative shadow-2xl font-sans">
      {/* Top Bar */}
      <header className="bg-white/80 backdrop-blur-md sticky top-0 z-10 px-6 py-4 flex justify-between items-center border-b border-gray-100">
        <div className="flex items-center space-x-2">
          <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
          <h1 className="font-bold text-gray-800 text-lg">W & L 記帳</h1>
        </div>
        <button onClick={fetchData} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors relative">
          <RefreshCw size={18} className={`text-gray-600 ${loading ? 'animate-spin' : ''}`} />
          {isOffline && <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
        </button>
      </header>

      {/* Main Content */}
      <main className="p-4 min-h-[80vh]">
        {view === 'dashboard' && renderDashboard()}
        {view === 'add' && renderAddTransaction()}
        {view === 'assets' && renderAssets()}
        {view === 'analysis' && renderAnalysis()}
      </main>

      {/* Bottom Navigation */}
      <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 h-20 pb-4 z-20 flex justify-around items-center px-2">
        <NavItem id="dashboard" icon={Home} label="總覽" />
        <NavItem id="add" icon={PlusCircle} label="記帳" />
        <NavItem id="assets" icon={TrendingUp} label="資產" />
        <NavItem id="analysis" icon={PieChartIcon} label="分析" />
      </nav>
    </div>
  );
}
