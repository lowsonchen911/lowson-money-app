<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家庭記帳 PWA (自定義版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f3f4f6; }
        .app-container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        /* 隱藏捲軸但保留功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col">
    
    <header class="bg-slate-800 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
        <h1 class="text-lg font-bold">家庭記帳 PWA</h1>
        <button @click="exportCSV" class="text-xs bg-green-600 px-2 py-1 rounded hover:bg-green-500">匯出 CSV</button>
    </header>

    <div v-if="currentTab !== 'settings'" class="p-4 bg-slate-800 text-white rounded-b-3xl shadow-lg mb-4 transition-all">
        <div class="text-slate-400 text-sm">目前總資產</div>
        <div class="text-4xl font-bold my-2">{{ formatMoney(totalAssets) }}</div>
        <div class="flex gap-2 mt-4 overflow-x-auto pb-2 no-scrollbar">
            <div v-for="(balance, acc) in accountBalances" :key="acc" class="bg-slate-700 px-3 py-2 rounded-lg min-w-[120px] flex-shrink-0">
                <div class="text-xs text-slate-300 truncate">{{ acc }}</div>
                <div class="font-semibold" :class="balance < 0 ? 'text-red-400' : 'text-green-400'">{{ formatMoney(balance) }}</div>
            </div>
        </div>
    </div>

    <div class="flex justify-center gap-2 mb-4 px-4">
        <button @click="currentTab = 'list'" :class="currentTab === 'list' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">列表</button>
        <button @click="currentTab = 'add'" :class="currentTab === 'add' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">記一筆</button>
        <button @click="currentTab = 'chart'" :class="currentTab === 'chart' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">報表</button>
        <button @click="currentTab = 'settings'" :class="currentTab === 'settings' ? 'bg-slate-800 text-white' : 'bg-gray-200 text-gray-600'" class="flex-1 py-2 rounded-lg font-bold text-sm transition">設定</button>
    </div>

    <div v-if="currentTab === 'list'" class="flex-1 overflow-y-auto px-4 pb-20">
        <div v-if="transactions.length === 0" class="text-center text-gray-400 mt-10">
            目前沒有資料，快去記一筆吧！
        </div>
        <div v-for="(tx, index) in sortedTransactions" :key="index" class="bg-white border-b border-gray-100 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0"
                     :class="getCategoryColor(tx.category)">
                    {{ tx.category.substring(0,1) }}
                </div>
                <div class="overflow-hidden">
                    <div class="font-bold text-gray-800 truncate">{{ tx.note || tx.category }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ tx.date }} • {{ tx.user }} • {{ tx.account }}</div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="font-bold text-lg" :class="tx.amount >= 0 ? 'text-green-600' : 'text-red-600'">
                    {{ formatMoney(tx.amount) }}
                </div>
                <button @click="deleteTransaction(index)" class="text-xs text-red-400 underline mt-1">刪除</button>
            </div>
        </div>
    </div>

    <div v-if="currentTab === 'add'" class="px-6 pb-20">
        <h2 class="text-xl font-bold mb-4 text-gray-700">新增交易</h2>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-gray-600 mb-1">日期</label>
                <input type="date" v-model="newTx.date" class="w-full p-3 border rounded-lg bg-white">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">使用者</label>
                    <select v-model="newTx.user" class="w-full p-3 border rounded-lg bg-white">
                        <option v-for="u in options.users" :value="u">{{ u }}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">帳戶</label>
                    <select v-model="newTx.account" class="w-full p-3 border rounded-lg bg-white">
                        <option v-for="a in options.accounts" :value="a">{{ a }}</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">交易類別</label>
                <select v-model="newTx.category" class="w-full p-3 border rounded-lg bg-white">
                    <option v-for="c in options.categories" :value="c">{{ c }}</option>
                </select>
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">金額 (正數收入，負數支出)</label>
                <input type="number" v-model.number="newTx.amount" class="w-full p-3 border rounded-lg bg-white text-xl" placeholder="-100">
            </div>

            <div>
                <label class="block text-sm text-gray-600 mb-1">備註說明</label>
                <input type="text" v-model="newTx.note" class="w-full p-3 border rounded-lg bg-white" placeholder="例如：吃午餐">
            </div>

            <button @click="addTransaction" class="w-full bg-slate-800 text-white py-4 rounded-lg text-lg font-bold shadow-lg mt-4 active:bg-slate-900">
                確認儲存
            </button>
        </div>
    </div>

    <div v-show="currentTab === 'chart'" class="px-4 pb-20 pt-4">
        <div class="bg-white p-4 rounded-xl shadow mb-4">
            <h3 class="font-bold text-gray-700 mb-4 text-center">資產分佈 (帳戶餘額)</h3>
            <canvas id="assetChart"></canvas>
        </div>
        <div class="text-center text-sm text-gray-500">圖表將隨資料自動更新</div>
    </div>

    <div v-if="currentTab === 'settings'" class="px-4 pb-20">
        <h2 class="text-xl font-bold mb-4 text-gray-700 mt-4">選項設定</h2>
        <p class="text-sm text-gray-500 mb-4">在此新增或刪除下拉選單的項目。</p>

        <div v-for="(list, key) in optionLabels" :key="key" class="mb-6 bg-white p-4 rounded-lg shadow-sm border">
            <h3 class="font-bold text-slate-700 mb-2 border-b pb-2">{{ list.title }}</h3>
            <div class="flex flex-wrap gap-2 mb-3">
                <div v-for="(item, idx) in options[key]" :key="idx" class="bg-gray-100 px-3 py-1 rounded-full flex items-center gap-2 text-sm">
                    {{ item }}
                    <button @click="removeItem(key, idx)" class="text-red-400 hover:text-red-600 font-bold px-1">×</button>
                </div>
            </div>
            <div class="flex gap-2">
                <input type="text" v-model="tempInput[key]" :placeholder="'新增' + list.title" class="flex-1 border rounded px-3 py-2 text-sm">
                <button @click="addItem(key)" class="bg-slate-700 text-white px-4 py-2 rounded text-sm">新增</button>
            </div>
        </div>

        <div class="mt-8 p-4 bg-red-50 border border-red-100 rounded-lg">
            <h3 class="text-red-800 font-bold mb-2">危險區域</h3>
            <button @click="resetAllData" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 transition">
                清除所有資料與設定 (重置)
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'list',
                // 選項資料 (預設值)
                options: {
                    users: ['lowson', 'wisdom'],
                    accounts: ['現金', '中信薪轉帳戶', '彰銀房貸帳戶', '富邦cube信用卡'],
                    categories: ['餐飲支出', '提款轉帳', '薪資獎金']
                },
                // 設定頁面顯示用
                optionLabels: {
                    users: { title: '使用者' },
                    accounts: { title: '帳戶' },
                    categories: { title: '交易類別' }
                },
                // 設定頁面輸入框暫存
                tempInput: { users: '', accounts: '', categories: '' },
                
                // 交易資料
                transactions: [],
                
                // 新增交易表單 (預設值已更新)
                newTx: {
                    date: new Date().toISOString().split('T')[0],
                    user: 'wisdom',       // 預設改為 wisdom
                    account: '現金',      // 預設改為 現金
                    category: '餐飲支出', // 預設改為 餐飲支出
                    amount: null,
                    note: ''
                },
                chartInstance: null
            }
        },
        computed: {
            sortedTransactions() {
                return [...this.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            },
            totalAssets() {
                return this.transactions.reduce((sum, t) => sum + t.amount, 0);
            },
            accountBalances() {
                const bals = {};
                // 確保所有設定中的帳戶都顯示，即使餘額為 0
                this.options.accounts.forEach(acc => bals[acc] = 0);
                
                this.transactions.forEach(t => {
                    bals[t.account] = (bals[t.account] || 0) + t.amount;
                });
                return bals;
            }
        },
        mounted() {
            // 1. 讀取資料
            const savedData = localStorage.getItem('accounting_data');
            if (savedData) {
                this.transactions = JSON.parse(savedData);
            } else {
                // 若完全無資料，載入範例資料 (可選)
                this.transactions = this.getInitialData();
            }

            // 2. 讀取自定義選項
            const savedOptions = localStorage.getItem('accounting_options');
            if (savedOptions) {
                this.options = JSON.parse(savedOptions);
            }

            this.renderChart();
        },
        watch: {
            transactions: {
                deep: true,
                handler() {
                    localStorage.setItem('accounting_data', JSON.stringify(this.transactions));
                    this.renderChart();
                }
            },
            options: {
                deep: true,
                handler() {
                    localStorage.setItem('accounting_options', JSON.stringify(this.options));
                    // 選項變更可能會影響圖表標籤，重繪
                    this.renderChart();
                }
            },
            currentTab(val) {
                if (val === 'chart') {
                    this.$nextTick(() => this.renderChart());
                }
            }
        },
        methods: {
            formatMoney(val) {
                return '$' + val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            },
            getInitialData() {
                return [
                    { date: '2025-11-05', user: 'lowson', account: '現金', category: '餐飲支出', amount: -100, note: '吃上飽' },
                    { date: '2025-11-03', user: 'lowson', account: '中信薪轉帳戶', category: '薪資獎金', amount: 200000, note: '10月薪資' }
                ];
            },
            addTransaction() {
                if (!this.newTx.amount) return alert('請輸入金額');
                
                this.transactions.push({ ...this.newTx });
                
                // 記帳後重置金額，保留日期與其他選項方便連續記帳
                this.newTx.amount = null;
                this.newTx.note = '';
                
                alert('記帳成功！');
                this.currentTab = 'list';
            },
            deleteTransaction(index) {
                if (confirm('確定要刪除這筆紀錄嗎？')) {
                    const txToDelete = this.sortedTransactions[index];
                    const originalIndex = this.transactions.indexOf(txToDelete);
                    if(originalIndex > -1) this.transactions.splice(originalIndex, 1);
                }
            },
            // --- 設定頁面功能 ---
            addItem(key) {
                const val = this.tempInput[key].trim();
                if (!val) return;
                if (this.options[key].includes(val)) return alert('該項目已存在');
                
                this.options[key].push(val);
                this.tempInput[key] = ''; // 清空輸入框
            },
            removeItem(key, idx) {
                if (confirm('確定要刪除此選項嗎？(不會影響已建立的交易紀錄)')) {
                    this.options[key].splice(idx, 1);
                }
            },
            resetAllData() {
                if(confirm('警告：這將會刪除所有記帳資料與設定，無法復原！確定嗎？')) {
                    localStorage.removeItem('accounting_data');
                    localStorage.removeItem('accounting_options');
                    location.reload();
                }
            },
            // ------------------
            getCategoryColor(cat) {
                if (cat.includes('支出') || cat.includes('費') || cat.includes('水電')) return 'bg-red-400';
                if (cat.includes('薪資') || cat.includes('收入') || cat.includes('獎金')) return 'bg-green-500';
                return 'bg-blue-400';
            },
            exportCSV() {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
                csvContent += "日期,使用者,帳戶,類別,金額,備註\n";
                this.transactions.forEach(row => {
                    csvContent += `${row.date},${row.user},${row.account},${row.category},${row.amount},${row.note}\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "記帳備份.csv");
                document.body.appendChild(link);
                link.click();
            },
            renderChart() {
                const ctx = document.getElementById('assetChart');
                if (!ctx) return;

                // 過濾掉餘額為 0 的帳戶 (讓圖表好看一點)
                const labels = Object.keys(this.accountBalances).filter(k => this.accountBalances[k] !== 0);
                const data = labels.map(k => this.accountBalances[k]);
                const colors = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#6366f1', '#8b5cf6', '#ec4899'];

                if (this.chartInstance) this.chartInstance.destroy();

                this.chartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            hoverOffset: 4
                        }]
                    }
                });
            }
        }
    });
</script>
</body>
</html>
