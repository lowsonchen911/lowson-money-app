<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智慧記帳本 PWA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#10b981">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuaZr+aFp+iomOW4syIsCiAgInNob3J0X25hbWUiOiAi5pmv5oWn6KiY5bizIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMTBiOTgxIiwKICAiaWNvbnMiOiBbXQp9">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Libraries: SheetJS (Excel), Recharts (Charts), Lucide (Icons) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, select { font-size: 16px !important; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } = Recharts;

        // --- 設定與常數 ---
        // 您的 Google Apps Script 網址 (已內建)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxv6EzQOZxAi3kyh5dK1rofcYL_p-phPymLD3Hqi-cc0Ih7WU1EezNmqUkgdCqyaw/exec";

        const DEFAULT_USERS = ["wisdom", "lowson"];
        const DEFAULT_TX_TYPES = ["支出", "收入", "提款轉帳", "資產投資"];
        const DEFAULT_ACCOUNTS = ["現金", "中信薪轉帳戶", "彰銀房貸帳戶", "永豐股票帳戶"];
        const DEFAULT_INVEST_ACCOUNTS = ["凱基債劵帳戶", "永豐債劵帳戶", "永豐股票帳戶"];
        const DEFAULT_CAT_INCOME = ["薪資獎金", "股票股利", "債卷配息"];
        const DEFAULT_CAT_EXPENSE = ["餐飲支出", "水電瓦斯", "生活用品", "休閒旅遊", "醫療保險"];
        const DEFAULT_CAT_TRANSFER = ["提款", "轉帳", "繳卡費", "繳貸款"];
        const DEFAULT_ASSETS = ["00981B", "00937B", "00945B", "00953B", "0050"];
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d'];

        // --- Custom Hook: 管理可新增的列表 (存於 LocalStorage) ---
        const usePersistedList = (key, defaultList) => {
            const [list, setList] = useState(defaultList);
            useEffect(() => {
                const stored = localStorage.getItem(`LIST_${key}`);
                if (stored) { try { setList(JSON.parse(stored)); } catch (e) {} }
            }, [key]);
            const addItem = (item) => {
                if (item && !list.includes(item)) {
                    const newList = [...list, item];
                    setList(newList);
                    localStorage.setItem(`LIST_${key}`, JSON.stringify(newList));
                }
            };
            return [list, addItem];
        };

        // --- Icon 元件 ---
        const Icon = ({ name, className }) => {
            useEffect(() => { lucide.createIcons(); });
            return <i data-lucide={name} className={className}></i>;
        };

        // --- 元件: 帶有新增按鈕的下拉選單 ---
        const CreatableSelect = ({ label, value, onChange, options, onAdd, placeholder = "請選擇" }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newValue, setNewValue] = useState("");

            const handleAdd = () => {
                if (newValue.trim()) {
                    onAdd(newValue.trim());
                    onChange(newValue.trim());
                    setIsAdding(false);
                    setNewValue("");
                }
            };

            return (
                <div className="mb-3">
                    <label className="block text-xs text-gray-500 mb-1">{label}</label>
                    <div className="flex gap-2 items-center h-11">
                        {isAdding ? (
                            <>
                                <input 
                                    type="text" 
                                    value={newValue} 
                                    onChange={e => setNewValue(e.target.value)}
                                    className="flex-1 p-2 border-2 border-emerald-500 rounded-lg outline-none text-sm h-full bg-white"
                                    placeholder={`新增${label}...`}
                                    autoFocus
                                />
                                <button type="button" onClick={handleAdd} className="h-full px-3 bg-emerald-600 text-white rounded-lg shadow active:scale-95 transition flex items-center justify-center">
                                    <Icon name="check" className="w-5 h-5"/>
                                </button>
                                <button type="button" onClick={() => setIsAdding(false)} className="h-full px-3 bg-gray-200 text-gray-600 rounded-lg shadow active:scale-95 transition flex items-center justify-center">
                                    <Icon name="x" className="w-5 h-5"/>
                                </button>
                            </>
                        ) : (
                            <>
                                <div className="relative flex-1 h-full">
                                    <select 
                                        value={value} 
                                        onChange={e => onChange(e.target.value)} 
                                        className="w-full h-full p-2 bg-white border border-gray-200 rounded-lg outline-none focus:border-emerald-500 appearance-none text-gray-700"
                                    >
                                        <option value="" disabled>{placeholder}</option>
                                        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg className="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                    </div>
                                </div>
                                <button 
                                    type="button" 
                                    onClick={() => setIsAdding(true)} 
                                    className="h-full px-3 bg-emerald-50 text-emerald-600 border border-emerald-200 rounded-lg active:scale-95 transition flex items-center justify-center hover:bg-emerald-100"
                                    title="新增選項"
                                >
                                    <Icon name="plus" className="w-5 h-5"/>
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const formatMoney = (amount) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', minimumFractionDigits: 0 }).format(amount);
        const getCurrentDate = () => new Date().toISOString().split('T')[0];

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [transactions, setTransactions] = useState([]);
            const [loading, setLoading] = useState(false);
            // 使用內建網址
            const [googleScriptUrl, setGoogleScriptUrl] = useState(localStorage.getItem('googleScriptUrl') || GOOGLE_SCRIPT_URL);
            const [msg, setMsg] = useState(null);
            const [isLoaded, setIsLoaded] = useState(false); 

            // 列表管理
            const [users, addUser] = usePersistedList('USERS', DEFAULT_USERS);
            const [txTypes, addTxType] = usePersistedList('TX_TYPES', DEFAULT_TX_TYPES);
            const [accounts, addAccount] = usePersistedList('ACCOUNTS', DEFAULT_ACCOUNTS);
            const [investAccounts, addInvestAccount] = usePersistedList('INVEST_ACCOUNTS', DEFAULT_INVEST_ACCOUNTS);
            const [assets, addAsset] = usePersistedList('ASSETS', DEFAULT_ASSETS);
            const [catIncome, addCatIncome] = usePersistedList('CAT_INCOME', DEFAULT_CAT_INCOME);
            const [catExpense, addCatExpense] = usePersistedList('CAT_EXPENSE', DEFAULT_CAT_EXPENSE);
            const [catTransfer, addCatTransfer] = usePersistedList('CAT_TRANSFER', DEFAULT_CAT_TRANSFER);

            // 1. 讀取資料
            useEffect(() => {
                const savedData = localStorage.getItem('transactions');
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (Array.isArray(parsed)) setTransactions(parsed);
                    } catch (e) { console.error("Load Error", e); }
                }
                setIsLoaded(true);
                lucide.createIcons();
            }, []);

            // 2. 儲存資料
            useEffect(() => {
                if (isLoaded) {
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                }
            }, [transactions, isLoaded]);

            const showMsg = (text, type = 'success') => {
                setMsg({ text, type });
                setTimeout(() => setMsg(null), 3000);
            };

            const syncToGoogle = async () => {
                if (transactions.length === 0) return showMsg("目前沒有資料可同步", "error");
                setLoading(true);
                try {
                    // 使用 text/plain 避免 CORS 預檢問題
                    await fetch(googleScriptUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'upload', data: transactions })
                    });
                    showMsg("同步請求已發送");
                } catch (e) { 
                    console.error(e);
                    showMsg("已發送請求 (若無更新請檢查 GAS 權限)", "success"); 
                }
                finally { setLoading(false); }
            };

            const loadFromGoogle = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${googleScriptUrl}?action=download`);
                    const data = await res.json();
                    if (Array.isArray(data)) {
                        setTransactions(data);
                        showMsg(`下載成功，共 ${data.length} 筆`);
                    }
                } catch (e) { 
                    console.error(e);
                    showMsg("下載失敗，請檢查網路", "error"); 
                }
                finally { setLoading(false); }
            };

            const exportExcel = () => {
                if (!window.XLSX || transactions.length === 0) return showMsg("無資料可匯出", "error");
                const ws = XLSX.utils.json_to_sheet(transactions);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Transactions");
                XLSX.writeFile(wb, `記帳備份_${getCurrentDate()}.xlsx`);
            };

            const importExcel = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        if (data.length > 0) {
                            setTransactions([...transactions, ...data]);
                            showMsg(`匯入 ${data.length} 筆資料`);
                        } else { showMsg("Excel 無資料", "error"); }
                    } catch (err) { showMsg("匯入失敗", "error"); }
                };
                reader.readAsBinaryString(file);
            };

            const addTransaction = (record) => {
                setTransactions([{ id: Date.now().toString(), date: getCurrentDate(), timestamp: new Date().toISOString(), ...record }, ...transactions]);
                showMsg("記帳成功");
            };

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <header className="bg-emerald-600 text-white p-4 sticky top-0 z-10 shadow-md flex justify-between items-center">
                        <h1 className="text-lg font-bold flex items-center gap-2"><Icon name="wallet" className="w-6 h-6"/> 智慧記帳本</h1>
                        <button onClick={syncToGoogle} className="p-2 bg-emerald-700 rounded-full active:scale-95 transition"><Icon name="cloud-upload" className="w-5 h-5"/></button>
                    </header>

                    <main className="p-4 max-w-md mx-auto">
                        {msg && <div className={`fixed top-16 left-4 right-4 p-3 rounded-xl shadow-lg text-white text-center z-50 ${msg.type === 'error' ? 'bg-red-500' : 'bg-gray-800'} animate-fade-in`}>{msg.text}</div>}
                        {loading && <div className="text-center py-4 text-gray-500">處理中...</div>}

                        {view === 'dashboard' && <Dashboard transactions={transactions} url={googleScriptUrl} showMsg={showMsg} />}
                        {view === 'entry' && (
                            <EntryForm 
                                onSave={addTransaction}
                                lists={{ users, txTypes, accounts, investAccounts, assets, catIncome, catExpense, catTransfer }}
                                adders={{ 
                                    onAddUser: addUser, onAddTxType: addTxType, 
                                    onAddAccount: addAccount, onAddInvestAccount: addInvestAccount, 
                                    onAddAsset: addAsset, onAddCatIncome: addCatIncome, 
                                    onAddCatExpense: addCatExpense, onAddCatTransfer: addCatTransfer 
                                }}
                            />
                        )}
                        {view === 'analysis' && <Analysis transactions={transactions} />}
                        {view === 'settings' && <Settings onExport={exportExcel} onImport={importExcel} onLoadCloud={loadFromGoogle} />}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-around p-2 pb-safe z-10">
                        <NavBtn icon="layout-dashboard" label="總覽" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                        <NavBtn icon="plus-circle" label="記帳" active={view === 'entry'} onClick={() => setView('entry')} />
                        <NavBtn icon="pie-chart" label="分析" active={view === 'analysis'} onClick={() => setView('analysis')} />
                        <NavBtn icon="settings" label="設定" active={view === 'settings'} onClick={() => setView('settings')} />
                    </nav>
                </div>
            );
        };

        const Dashboard = ({ transactions, url, showMsg }) => {
            const [prices, setPrices] = useState({});
            const [updating, setUpdating] = useState(false);

            const stats = useMemo(() => {
                const currentMonth = new Date().getMonth();
                let monthlyIncome = 0, monthlyExpense = 0, balances = {}, assets = {};
                transactions.forEach(t => {
                    const val = Number(t['金額']) || 0;
                    const type = t['交易方式'];
                    const acct = t['交易帳戶'];
                    const acctIn = t['交易帳戶(轉入)'];
                    
                    if (new Date(t.timestamp || t.date).getMonth() === currentMonth) {
                        if (type === '收入') monthlyIncome += val;
                        if (type === '支出') monthlyExpense += val;
                    }
                    if (!balances[acct]) balances[acct] = 0;
                    if (type === '收入') balances[acct] += val;
                    if (type === '支出' || type === '資產投資') balances[acct] -= val;
                    if (type === '提款轉帳') { balances[acct] -= val; if (acctIn) { if (!balances[acctIn]) balances[acctIn] = 0; balances[acctIn] += val; } }
                    if (type === '資產投資') {
                        const name = t['資產名稱'];
                        if (!assets[name]) assets[name] = { qty: 0, cost: 0 };
                        assets[name].qty += (Number(t['資產數量']) || 0);
                        assets[name].cost += val;
                    }
                });
                return { monthlyIncome, monthlyExpense, balances, assets };
            }, [transactions]);

            const fetchPrices = async () => {
                const tickers = Object.keys(stats.assets);
                if (tickers.length === 0) return;
                setUpdating(true);
                try {
                    // POST request content-type text/plain to avoid preflight
                    const res = await fetch(url, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify({ action: 'getPrices', tickers })
                    });
                    const data = await res.json();
                    setPrices(data);
                    showMsg("股價更新成功");
                } catch (e) { 
                    console.error(e); 
                    showMsg("股價更新中 (請稍後)", "success"); 
                }
                setUpdating(false);
            };

            return (
                <div className="space-y-4 animate-fade-in">
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-400"><div className="text-xs text-gray-400 mb-1">本月支出</div><div className="text-xl font-bold text-gray-800">{formatMoney(stats.monthlyExpense)}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-400"><div className="text-xs text-gray-400 mb-1">本月收入</div><div className="text-xl font-bold text-gray-800">{formatMoney(stats.monthlyIncome)}</div></div>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-3 border-b pb-2">帳戶餘額</h3><div className="space-y-3">{Object.entries(stats.balances).map(([acc, bal]) => (<div key={acc} className="flex justify-between items-center"><span className="text-sm text-gray-600">{acc}</span><span className={`font-mono font-medium ${bal < 0 ? 'text-red-500' : 'text-gray-800'}`}>{formatMoney(bal)}</span></div>))}</div></div>
                    
                    {/* 資產庫存表 */}
                    <div className="bg-white p-4 rounded-xl shadow-sm">
                        <div className="flex justify-between items-center mb-3 border-b pb-2">
                            <h3 className="font-bold text-gray-700">資產庫存</h3>
                            <button onClick={fetchPrices} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded flex items-center gap-1">{updating ? "更新中..." : "更新現價"}</button>
                        </div>
                        {Object.keys(stats.assets).length === 0 ? <div className="text-gray-400 text-sm text-center py-2">無紀錄</div> : (
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead>
                                        <tr className="text-gray-500 border-b"><th className="pb-2">資產</th><th className="pb-2 text-right">股數</th><th className="pb-2 text-right">成本</th><th className="pb-2 text-right">價值</th></tr>
                                    </thead>
                                    <tbody>
                                        {Object.entries(stats.assets).map(([name, data]) => {
                                            const currentPrice = prices[name] || 0;
                                            const currentValue = currentPrice * data.qty;
                                            return (
                                                <tr key={name} className="border-b last:border-0">
                                                    <td className="py-2 font-medium">{name}</td>
                                                    <td className="py-2 text-right">{data.qty}</td>
                                                    <td className="py-2 text-right text-gray-600">{formatMoney(data.cost)}</td>
                                                    <td className="py-2 text-right font-bold text-blue-600">
                                                        {currentPrice > 0 ? formatMoney(currentValue) : "---"}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                                <p className="text-xs text-gray-400 mt-2 text-right">* 價值需透過後端更新</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EntryForm = ({ onSave, lists, adders }) => {
            const [user, setUser] = useState('wisdom');
            const [type, setType] = useState('支出');
            const [amount, setAmount] = useState('');
            const [note, setNote] = useState('');
            const [account, setAccount] = useState('');
            const [accountTo, setAccountTo] = useState('');
            const [category, setCategory] = useState('');
            const [assetName, setAssetName] = useState('');
            const [assetQty, setAssetQty] = useState('');
            const [assetPrice, setAssetPrice] = useState('');

            useEffect(() => {
                const { accounts, catIncome, catExpense, catTransfer, investAccounts, assets } = lists;
                if (type === '收入') { setAccount(accounts[1] || accounts[0]); setCategory(catIncome[0]); }
                else if (type === '支出') { setAccount(accounts[0]); setCategory(catExpense[0]); }
                else if (type === '提款轉帳') { setAccount(accounts[0]); setAccountTo(accounts[0]); setCategory(catTransfer[0]); }
                else if (type === '資產投資') { setAccount(investAccounts[0] || accounts[0]); setAssetName(assets[0]); }
                else { setAccount(accounts[0]); setCategory(catExpense[0] || '雜項'); }
            }, [type, lists]);

            useEffect(() => {
                if (type === '資產投資' && assetQty && assetPrice) setAmount(Math.floor(Number(assetQty) * Number(assetPrice)));
            }, [assetQty, assetPrice, type]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount) return;
                const record = {
                    "使用者": user, "交易方式": type, "交易帳戶": account, "交易帳戶(轉入)": type === '提款轉帳' ? accountTo : "",
                    "交易類別": category, "資產名稱": type === '資產投資' ? assetName : "", "資產數量": type === '資產投資' ? Number(assetQty) : "",
                    "資產單價": type === '資產投資' ? Number(assetPrice) : "", "金額": Number(amount), "備註": note
                };
                onSave(record);
                setAmount(''); setNote(''); setAssetQty('');
            };

            const isIncome = type === '收入';
            const isTransfer = type === '提款轉帳';
            const isInvest = type === '資產投資';

            return (
                <form onSubmit={handleSubmit} className="bg-white p-5 rounded-xl shadow-sm space-y-4 animate-fade-in">
                    <CreatableSelect label="使用者" value={user} onChange={setUser} options={lists.users} onAdd={adders.onAddUser} />
                    <CreatableSelect label="交易方式" value={type} onChange={setType} options={lists.txTypes} onAdd={adders.onAddTxType} />
                    <CreatableSelect label={isTransfer ? "轉出帳戶" : "交易帳戶"} value={account} onChange={setAccount} options={isInvest ? lists.investAccounts : lists.accounts} onAdd={isInvest ? adders.onAddInvestAccount : adders.onAddAccount} />
                    {isTransfer && <CreatableSelect label="轉入帳戶" value={accountTo} onChange={setAccountTo} options={lists.accounts} onAdd={adders.onAddAccount} />}
                    {!isInvest && <CreatableSelect label="交易類別" value={category} onChange={setCategory} options={isIncome ? lists.catIncome : isTransfer ? lists.catTransfer : lists.catExpense} onAdd={isIncome ? adders.onAddCatIncome : isTransfer ? adders.onAddCatTransfer : adders.onAddCatExpense} />}
                    {isInvest && (
                        <div className="grid grid-cols-2 gap-3 p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <div className="col-span-2"><CreatableSelect label="資產名稱" value={assetName} onChange={setAssetName} options={lists.assets} onAdd={adders.onAddAsset} /></div>
                            <div><label className="block text-xs text-blue-600 mb-1">數量</label><input type="number" value={assetQty} onChange={e => setAssetQty(e.target.value)} className="w-full p-2 border rounded" placeholder="股/張" /></div>
                            <div><label className="block text-xs text-blue-600 mb-1">單價</label><input type="number" value={assetPrice} onChange={e => setAssetPrice(e.target.value)} className="w-full p-2 border rounded" placeholder="$" /></div>
                        </div>
                    )}
                    <div><label className="block text-xs text-gray-500 mb-1">金額</label><input type="number" value={amount} onChange={e => setAmount(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-lg font-mono font-bold text-gray-700" placeholder="NT$ 0" required /></div>
                    <div><label className="block text-xs text-gray-500 mb-1">備註</label><input type="text" value={note} onChange={e => setNote(e.target.value)} className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg" placeholder="選填..." /></div>
                    <button type="submit" className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700 active:scale-95 transition mt-4">確認記帳</button>
                </form>
            );
        };

        const Analysis = ({ transactions }) => {
            const data = useMemo(() => {
                const catMap = {};
                transactions.filter(t => t['交易方式'] === '支出').forEach(t => { catMap[t['交易類別']||'其他'] = (catMap[t['交易類別']||'其他'] || 0) + Number(t['金額']); });
                const pieData = Object.keys(catMap).map(k => ({ name: k, value: catMap[k] }));
                const trendMap = {};
                transactions.forEach(t => {
                    const d = new Date(t.timestamp || t.date);
                    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    if (!trendMap[key]) trendMap[key] = { name: key, income: 0, expense: 0 };
                    if (t['交易方式'] === '收入') trendMap[key].income += Number(t['金額']);
                    if (t['交易方式'] === '支出') trendMap[key].expense += Number(t['金額']);
                });
                const barData = Object.values(trendMap).sort((a,b) => a.name.localeCompare(b.name));
                return { pieData, barData };
            }, [transactions]);

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="bg-white p-4 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-4 text-center">支出分佈</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={data.pieData} dataKey="value" nameKey="name" cx="50%" cy="50%" outerRadius={80} label>{data.pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}</Pie><Tooltip formatter={(val) => formatMoney(val)} /><Legend /></PieChart></ResponsiveContainer></div></div>
                    <div className="bg-white p-4 rounded-xl shadow-sm"><h3 className="font-bold text-gray-700 mb-4 text-center">收支趨勢</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><BarChart data={data.barData}><CartesianGrid strokeDasharray="3 3" /><XAxis dataKey="name" fontSize={12} /><YAxis fontSize={12} /><Tooltip formatter={(val) => formatMoney(val)} /><Legend /><Bar dataKey="income" name="收入" fill="#34d399" /><Bar dataKey="expense" name="支出" fill="#f87171" /></BarChart></ResponsiveContainer></div></div>
                </div>
            );
        };

        const NavBtn = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 w-full ${active ? 'text-emerald-600' : 'text-gray-400'}`}>
                <Icon name={icon} className="w-6 h-6 mb-1" />
                <span className="text-xs">{label}</span>
            </button>
        );

        const Settings = ({ onExport, onImport, onLoadCloud }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-white p-4 rounded-xl shadow-sm"><h2 className="font-bold mb-3 text-gray-700">雲端同步</h2><p className="text-sm text-gray-500 mb-2">使用內建 Google 試算表連結</p><button onClick={onLoadCloud} className="w-full bg-blue-50 text-blue-600 p-2 rounded font-medium text-sm hover:bg-blue-100">從雲端下載最新資料</button></div>
                <div className="bg-white p-4 rounded-xl shadow-sm"><h2 className="font-bold mb-3 text-gray-700">備份還原</h2><div className="grid grid-cols-2 gap-3"><button onClick={onExport} className="flex items-center justify-center gap-2 bg-green-50 text-green-700 p-3 rounded-lg border border-green-100"><Icon name="download" className="w-4 h-4" /> 匯出</button><label className="flex items-center justify-center gap-2 bg-amber-50 text-amber-700 p-3 rounded-lg border border-amber-100 cursor-pointer"><Icon name="upload" className="w-4 h-4" /> 匯入<input type="file" accept=".xlsx, .xls" onChange={onImport} className="hidden" /></label></div></div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
